<!DOCTYPE html>
<html lang='ja'>
<head>
<title>deviseをAPIで利用しやすくする -Token Authenticationの追加- | dev.wan.co</title>
<meta charset='utf-8'>
<meta content='rails, devise, api, cancancan, semantic-ui, simple_form' name='keywords'>
<meta content='認証のプラグインであるdeviseをJSON APIで利用しやすく拡張します。' name='description'>
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600' rel='stylesheet' type='text/css'>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-43663109-1', 'k-shogo.github.io');
  ga('send', 'pageview');
</script>

<!--[if lte IE 8]> <script src="js/html5shiv.js"></script> <![endif]-->
<script src="/js/all.js" type="text/javascript"></script>
<link href="/css/main.css" rel="stylesheet" type="text/css" />
</head>
<body>
<noscript>
<link href="/css/skel-noscript.css" rel="stylesheet" type="text/css" /><link href="/css/style.css" rel="stylesheet" type="text/css" /><link href="/css/style-desktop.css" rel="stylesheet" type="text/css" /><link href="/css/style-noscript.css" rel="stylesheet" type="text/css" />
</noscript>
<!--[if lte IE 8]> <link rel="stylesheet" href="css/ie8.css" /> <![endif]-->
<!-- Header -->
<div id='header'>
<!-- Inner -->
<div class='inner'>
<header>
<h1>
<div id='logo'><a href="/">Dev.Wan.Co</a></div>
</h1>
</header>
</div>
<!-- Nav -->
<nav id='nav'>
<ul>
<li>
<a href="/">Home</a>
</li>
<li>
<a href="/feed.xml">RSS Feed</a>
</li>
</ul>
</nav>
</div>
<!-- Main -->
<div class='wrapper style1'>
<div class='container'>
<div class='row'>
<div class='12u skel-cell-important' id='content'>
<article class='special' id='main'>
<header>
<h2>deviseをAPIで利用しやすくする -Token Authenticationの追加-</h2>
<span class='byline'>
<a href="/article/tags/rails/">rails</a>
<a href="/article/tags/devise/">devise</a>
</span>
</header>
<section><header><h3>はじめに</h3></header>

<p>この記事では認証のプラグインである<a href="https://github.com/plataformatec/devise">devise</a>を
JSON APIで利用しやすく拡張することを目的としています。</p>

<p>deviseにはトークンによる認証機能もありましたが、現在デフォルトでは削除されています。<br>
公式wiki <a href="https://github.com/plataformatec/devise/wiki/How-To:-Simple-Token-Authentication-Example">How To: Simple Token Authentication Example</a>には<code>TokenAuthenticatable</code>が削除された経緯や、
自分で実装する場合のサンプルへのリンクがありますが、気になる箇所があったため自分で実装した物をまとめます。</p>

<p>本サンプルアプリケーションのソースコードは<a href="https://github.com/k-shogo/devise_api_sample">github.com/k-shogo/devise<em>api</em>sample</a>で公開しています。</p>

<p>記事公開時の環境は以下の物になります。</p>
<pre class="highlight plaintext"><code>Ruby version              2.1.2-p95 (x86_64-darwin13.0)
RubyGems version          2.2.2
Rack version              1.5
Rails version             4.1.6
JavaScript Runtime        Node.js (V8)
</code></pre>

</section><section><header><h3>サンプルアプリケーション</h3></header>

<p>deviseの認証をweb, apiどちらからでも使用できるようにするサンプルアプリケーションを作成します。<br>
今回は単純なノートアプリを題材とします。
何はともあれ<code>rails new</code>から始めましょう。</p>
<pre class="highlight shell"><code>rails new devise_api_sample
</code></pre>

<p>認証の他に認可も行いたいので、<code>Gemfile</code>に<a href="https://github.com/plataformatec/devise">devise</a>と<a href="https://github.com/CanCanCommunity/cancancan">cancancan</a>を追記します。</p>
<pre class="highlight ruby"><code><span class="c1">#Authentication</span>
<span class="n">gem</span> <span class="s1">'devise'</span>
<span class="c1">#Authorization</span>
<span class="n">gem</span> <span class="s1">'cancancan'</span>
</code></pre>

<p>他にも、本サンプルでは
<a href="https://github.com/indirect/haml-rails">haml-rails</a>,
<a href="https://github.com/doabit/semantic-ui-sass">semantic-ui-sass</a>,
<a href="https://github.com/kossnocorp/jquery.turbolinks">jquery-turbolinks</a>,
<a href="https://github.com/plataformatec/simple_form">simple_form</a>,
<a href="https://github.com/comfy/active_link_to">active_link_to</a>
を使用しています。</p>

<p><code>bundle install</code>と<code>./bin/rake db:create</code>を忘れずに。</p>

</section><section><header><h3>ログインするユーザーを準備</h3></header>

<p>deviseでログインするユーザーのモデルを準備しましょう。<br>
同時にcancancanのabilityも用意しておきます。<br>
フォーム生成を楽にするために最初にsimple_formの準備をしています。</p>
<pre class="highlight shell"><code>./bin/rails g simple_form:install
./bin/rails g devise:install
./bin/rails g devise user
./bin/rails g devise:views users
./bin/rails g cancan:ability
</code></pre>

<p>トークン認証の機能のために、deviseで生成したマイグレーションに<code>authentication_token</code>カラムを追加します。</p>

<p><code>db/migrate/201409xxxxxxxx_devise_create_users.rb</code></p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">DeviseCreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1">## Database authenticatable</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span><span class="p">,</span>              <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="s2">""</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:encrypted_password</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="s2">""</span>

      <span class="c1">## Recoverable</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="ss">:reset_password_token</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:reset_password_sent_at</span>

      <span class="c1">## Rememberable</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:remember_created_at</span>

      <span class="c1">## Trackable</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span>  <span class="ss">:sign_in_count</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:current_sign_in_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:last_sign_in_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="ss">:current_sign_in_ip</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="ss">:last_sign_in_ip</span>

      <span class="c1">## Confirmable</span>
      <span class="c1"># t.string   :confirmation_token</span>
      <span class="c1"># t.datetime :confirmed_at</span>
      <span class="c1"># t.datetime :confirmation_sent_at</span>
      <span class="c1"># t.string   :unconfirmed_email # Only if using reconfirmable</span>

      <span class="c1">## Lockable</span>
      <span class="c1"># t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts</span>
      <span class="c1"># t.string   :unlock_token # Only if unlock strategy is :email or :both</span>
      <span class="c1"># t.datetime :locked_at</span>

      <span class="c1">## 認証トークン</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:authentication_token</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:email</span><span class="p">,</span>                <span class="ss">unique: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:reset_password_token</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
      <span class="c1"># t.index :confirmation_token,   unique: true</span>
      <span class="c1"># t.index :unlock_token,         unique: true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:authentication_token</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
    <span class="k">end</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>viewをカスタマイズするために生成したので、
<code>config/initializers/devise.rb</code>にて
<code>config.scoped_views = true</code>としておきます。</p>

</section><section><header><h3>ノートモデルを作る</h3></header>

<p>ユーザーと関連するノートのモデルを作成します。<br>
サンプルなので、タイトルと本文があるシンプルなモデルです。</p>
<pre class="highlight shell"><code>./bin/rails g scaffold note user:references title:string body:text
</code></pre>

<p>必要なマイグレーションは用意できたので、<code>./bin/rake db:migrate</code> します。</p>

<p>次に<code>app/models/ability.rb</code>でノートに関しての認可を設定します。</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Ability</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">Note</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span> <span class="k">if</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>abilityを設定したら、
<code>app/controllers/notes_controller.rb</code>に<code>load_and_authorize_resource</code>を追加して、アクセスコントロールします。</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">NotesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">load_and_authorize_resource</span>
  <span class="n">before_action</span> <span class="ss">:set_note</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>

  <span class="c1"># accessible_byでアクセスを制限</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@notes</span> <span class="o">=</span> <span class="no">Note</span><span class="p">.</span><span class="nf">accessible_by</span><span class="p">(</span><span class="n">current_ability</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@note</span> <span class="o">=</span> <span class="no">Note</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="c1"># ノートの作成者を設定</span>
    <span class="vi">@note</span> <span class="o">=</span> <span class="no">Note</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">note_params</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">user: </span><span class="n">current_user</span><span class="p">))</span>

    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="k">if</span> <span class="vi">@note</span><span class="p">.</span><span class="nf">save</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@note</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'Note was successfully created.'</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">status: :created</span><span class="p">,</span> <span class="ss">location: </span><span class="vi">@note</span> <span class="p">}</span>
      <span class="k">else</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:new</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@note</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="k">if</span> <span class="vi">@note</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">note_params</span><span class="p">)</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@note</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'Note was successfully updated.'</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">status: :ok</span><span class="p">,</span> <span class="ss">location: </span><span class="vi">@note</span> <span class="p">}</span>
      <span class="k">else</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:edit</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@note</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@note</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="n">notes_url</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'Note was successfully destroyed.'</span> <span class="p">}</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">head</span> <span class="ss">:no_content</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="c1"># Use callbacks to share common setup or constraints between actions.</span>
    <span class="k">def</span> <span class="nf">set_note</span>
      <span class="vi">@note</span> <span class="o">=</span> <span class="no">Note</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="c1"># Never trust parameters from the scary internet, only allow the white list through.</span>
    <span class="k">def</span> <span class="nf">note_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:note</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>ほぼデフォルトのままですが、
<code>index</code>では自分が作成したノートだけを返すように, 
<code>create</code>ではノートと作成者が関連付くように変更しています。</p>

</section><section><header><h3>見た目を調整</h3></header>

<p>ブラウザで動作確認したいので、ログイン/ログアウト出来るようにメニューバーを追加しておきます。</p>

<p><code>app/views/layouts/application.html.haml</code></p>
<pre class="highlight haml"><code><span class="nn">!!!
</span><span class="nt">%html</span>
  <span class="nt">%head</span>
    <span class="nt">%title</span> DeviseApiUse
    <span class="p">=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media: </span><span class="s1">'all'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
    <span class="p">=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span>
    <span class="p">=</span> <span class="n">csrf_meta_tags</span>
  <span class="nt">%body</span>
    <span class="p">=</span> <span class="n">render</span> <span class="s1">'menu'</span>
    <span class="nf">#messages</span>
      <span class="p">=</span> <span class="n">semantic_message</span>
    <span class="p">=</span> <span class="k">yield</span>
</code></pre>

<p><code>app/views/application/_menu.html.haml</code></p>
<pre class="highlight haml"><code><span class="nc">.ui.pointing.menu.large</span>
  <span class="p">-</span> <span class="k">if</span> <span class="n">can?</span> <span class="ss">:namage</span><span class="p">,</span> <span class="no">Note</span>
    <span class="p">=</span> <span class="n">active_link_to</span> <span class="n">notes_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'item'</span> <span class="k">do</span>
      <span class="p">=</span> <span class="n">semantic_icon</span><span class="p">(</span><span class="ss">:book</span><span class="p">)</span>
      ノート
  <span class="p">-</span> <span class="k">if</span> <span class="n">user_signed_in?</span>
    <span class="p">=</span> <span class="n">active_link_to</span> <span class="n">edit_user_registration_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'item'</span> <span class="k">do</span>
      <span class="p">=</span> <span class="n">semantic_icon</span><span class="p">(</span><span class="ss">:setting</span><span class="p">)</span>
      アカウント設定
  <span class="nc">.right.menu</span>
    <span class="p">-</span> <span class="k">if</span> <span class="n">user_signed_in?</span>
      <span class="p">=</span> <span class="n">link_to</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'item'</span> <span class="k">do</span>
        <span class="p">=</span> <span class="n">semantic_icon</span><span class="p">(</span><span class="ss">:sign</span><span class="p">,</span> <span class="ss">:out</span><span class="p">)</span>
        <span class="si">#{</span><span class="n">current_user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span>:ログアウト
    <span class="p">-</span> <span class="k">else</span>
      <span class="p">=</span> <span class="n">active_link_to</span> <span class="n">new_user_session_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'item'</span> <span class="k">do</span>
        <span class="p">=</span> <span class="n">semantic_icon</span><span class="p">(</span><span class="ss">:sign</span><span class="p">,</span> <span class="ss">:in</span><span class="p">)</span>
        ログイン
</code></pre>

<p><a href="https://github.com/k-shogo/devise_api_sample/blob/master/config/initializers/simple_form.rb">simple_formのsemantic-ui対応</a>
や
<a href="https://github.com/k-shogo/devise_api_sample/blob/master/app/helpers/semantic_ui_helper.rb">フラッシュメッセージ用helper</a>, <a href="https://github.com/k-shogo/devise_api_sample/blob/master/app/assets/javascripts/semantic_ui_helper.js.coffee">メッセージ削除用js</a>等はオマケ要素なのでgithubを参照してください。</p>

<p>画面はこんな感じになりました。
<img alt="main" width="1075" height="485" src="/images/2014-09-13-devise_authentication_token/main.png" /></p>

</section><section><header><h3>アクセストークン発行画面</h3></header>

<p>ユーザーの設定画面に、アクセストークン発行機能を追加します。<br>
まずはユーザーモデル<code>app/models/user.rb</code>にトークン発行の機能を持たせます。</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :confirmable, :lockable, :timeoutable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>

  <span class="c1"># 認証トークンはユニークに。ただしnilは許可</span>
  <span class="n">validates</span><span class="ss">:authentication_token</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">allow_nil: </span><span class="kp">true</span>
  <span class="n">has_many</span> <span class="ss">:notes</span>

  <span class="c1"># 認証トークンが無い場合は作成</span>
  <span class="k">def</span> <span class="nf">ensure_authentication_token</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">authentication_token</span> <span class="o">||</span> <span class="n">generate_authentication_token</span>
  <span class="k">end</span>

  <span class="c1"># 認証トークンの作成</span>
  <span class="k">def</span> <span class="nf">generate_authentication_token</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="n">old_token</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">authentication_token</span>
      <span class="n">token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">urlsafe_base64</span><span class="p">(</span><span class="mi">24</span><span class="p">).</span><span class="nf">tr</span><span class="p">(</span><span class="s1">'lIO0'</span><span class="p">,</span> <span class="s1">'sxyz'</span><span class="p">)</span>
      <span class="k">break</span> <span class="n">token</span> <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">authentication_token: </span><span class="n">token</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">old_token</span> <span class="o">!=</span> <span class="n">token</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">delete_authentication_token</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">authentication_token: </span><span class="kp">nil</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre>

<p>トークン管理用のコントローラー<code>app/controllers/authentication_tokens_controller.rb</code>を追加します。</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">AuthenticationTokensController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">generate_authentication_token</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span><span class="ss">token: </span><span class="n">token</span><span class="p">}.</span><span class="nf">to_json</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">delete_authentication_token</span>
    <span class="n">render</span> <span class="ss">nothing: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p><code>config/routes.rb</code>に<code>resource :authentication_token, only: [:update, :destroy]</code>を追加します。</p>

<p>ユーザーが自分でアクセストークンを発行できるように、
ユーザーの設定画面<code>app/views/users/registrations/edit.html.haml</code>に
アクセストークン発行ボタンをつけます。</p>
<pre class="highlight haml"><code><span class="nt">%h2</span>
  Edit <span class="si">#{</span><span class="n">resource_name</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">humanize</span><span class="si">}</span>
<span class="p">=</span> <span class="n">simple_form_for</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="ss">as: </span><span class="n">resource_name</span><span class="p">,</span> <span class="ss">url: </span><span class="n">registration_path</span><span class="p">(</span><span class="n">resource_name</span><span class="p">),</span> <span class="ss">html: </span><span class="p">{</span> <span class="ss">method: :put</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="p">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">error_notification</span>
  <span class="nc">.form-inputs</span>
    <span class="p">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">autofocus: </span><span class="kp">true</span>
    <span class="p">-</span> <span class="k">if</span> <span class="n">devise_mapping</span><span class="p">.</span><span class="nf">confirmable?</span> <span class="o">&amp;&amp;</span> <span class="n">resource</span><span class="p">.</span><span class="nf">pending_reconfirmation?</span>
      <span class="nt">%p</span>
        Currently waiting confirmation for: <span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">unconfirmed_email</span><span class="si">}</span>
    <span class="p">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">autocomplete: </span><span class="s2">"off"</span><span class="p">,</span> <span class="ss">hint: </span><span class="s2">"leave it blank if you don't want to change it"</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">false</span>
    <span class="p">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">false</span>
    <span class="p">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:current_password</span><span class="p">,</span> <span class="ss">hint: </span><span class="s2">"we need your current password to confirm your changes"</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
  <span class="nc">.form-actions</span>
    <span class="p">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">button</span> <span class="ss">:submit</span><span class="p">,</span> <span class="s2">"Update"</span>

<span class="nt">%h3</span> authentication token
<span class="nc">.ui.form.segment</span>
  <span class="nc">.field</span>
    <span class="nt">%input</span><span class="p">{</span><span class="ss">placeholder: </span><span class="s1">'authentication token'</span><span class="p">,</span> <span class="ss">readonly: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">type: </span><span class="s1">'text'</span><span class="p">,</span> <span class="ss">value: </span><span class="n">resource</span><span class="p">.</span><span class="nf">authentication_token</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'authentication_token'</span><span class="p">}</span>

  <span class="p">=</span> <span class="n">link_to</span> <span class="n">authentication_token_path</span><span class="p">,</span> <span class="ss">method: :put</span><span class="p">,</span> <span class="ss">remote: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'generate_authentication_token'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'ui button green'</span> <span class="k">do</span>
    <span class="p">=</span> <span class="n">semantic_icon</span> <span class="ss">:refresh</span>
    generate authentication token

  <span class="p">=</span> <span class="n">link_to</span> <span class="n">authentication_token_path</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">remote: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'delete_authentication_token'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'ui button red'</span><span class="k">do</span>
    <span class="p">=</span> <span class="n">semantic_icon</span> <span class="ss">:remove</span>
    delete authentication token

<span class="nt">%h3</span> Cancel my account
<span class="nt">%p</span>
  Unhappy? <span class="si">#{</span><span class="n">link_to</span> <span class="s2">"Cancel my account"</span><span class="p">,</span> <span class="n">registration_path</span><span class="p">(</span><span class="n">resource_name</span><span class="p">),</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="s2">"Are you sure?"</span> <span class="p">},</span> <span class="ss">method: :delete</span><span class="si">}</span>
<span class="p">=</span> <span class="n">link_to</span> <span class="s2">"Back"</span><span class="p">,</span> <span class="ss">:back</span>
</code></pre>

<p>アクセストークン発行ボタンは<code>remote</code>設定にしたので、
押下したときの動作を<code>app/assets/javascripts/authentication_token.js.coffee</code>で定義します。</p>
<pre class="highlight coffeescript"><code><span class="nx">$</span> <span class="o">-&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s">'#generate_authentication_token'</span><span class="p">)</span>
    <span class="p">.</span><span class="na">on</span> <span class="s">'ajax:complete'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">ajax</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">response</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="na">parseJSON</span><span class="p">(</span><span class="nx">ajax</span><span class="p">.</span><span class="na">responseText</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">'#authentication_token'</span><span class="p">).</span><span class="na">val</span> <span class="nx">response</span><span class="p">.</span><span class="na">token</span>
  <span class="nx">$</span><span class="p">(</span><span class="s">'#delete_authentication_token'</span><span class="p">)</span>
    <span class="p">.</span><span class="na">on</span> <span class="s">'ajax:complete'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">ajax</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">'#authentication_token'</span><span class="p">).</span><span class="na">val</span> <span class="s">''</span>
</code></pre>

<p><img alt="token" width="1074" height="746" src="/images/2014-09-13-devise_authentication_token/token.png" /></p>

<p>これで、設定画面で&ldquo;generate authentication token&quot;を押すとアクセストークンが発行されます。</p>

</section><section><header><h3>アクセストークンによる認証</h3></header>

<p>トークンの発行が出来るようになったので、
続いてトークンによる認証の機構を追加します。</p>

<p>今回は<code>app/controllers/application_controller.rb</code>に追加します。</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with: :exception</span>
  <span class="c1"># json でのリクエストの場合CSRFトークンの検証をスキップ</span>
  <span class="n">skip_before_action</span> <span class="ss">:verify_authenticity_token</span><span class="p">,</span>     <span class="ss">if: </span><span class="o">-&gt;</span> <span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="nf">format</span><span class="p">.</span><span class="nf">json?</span><span class="p">}</span>
  <span class="c1"># トークンによる認証</span>
  <span class="n">before_action</span>      <span class="ss">:authenticate_user_from_token!</span><span class="p">,</span> <span class="ss">if: </span><span class="o">-&gt;</span> <span class="p">{</span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">].</span><span class="nf">present?</span><span class="p">}</span>

  <span class="c1"># 権限無しのリソースにアクセスしようとした場合</span>
  <span class="n">rescue_from</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">AccessDenied</span> <span class="k">do</span> <span class="o">|</span><span class="n">exception</span><span class="o">|</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="n">main_app</span><span class="p">.</span><span class="nf">root_url</span><span class="p">,</span> <span class="ss">alert: </span><span class="n">exception</span><span class="p">.</span><span class="nf">message</span> <span class="p">}</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span><span class="ss">message: </span><span class="n">exception</span><span class="p">.</span><span class="nf">message</span><span class="p">},</span> <span class="ss">status: :unauthorized</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># トークンによる認証</span>
  <span class="k">def</span> <span class="nf">authenticate_user_from_token!</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
    <span class="k">if</span> <span class="no">Devise</span><span class="p">.</span><span class="nf">secure_compare</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">try</span><span class="p">(</span><span class="ss">:authentication_token</span><span class="p">),</span> <span class="n">params</span><span class="p">[</span><span class="ss">:token</span><span class="p">])</span>
      <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="ss">store: </span><span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>これで、リクエストパラメーターに<code>email</code>と<code>token</code>が含まれていた場合に、
トークンによってユーザーを認証出来るようになりました。</p>

</section><section><header><h3>deviseのjson API対応</h3></header>

<p>ここまででトークンによる認証は実装しましたが、
このままだとwebでユーザー登録 &amp; トークン発行後にしかAPIが利用できません。<br>
そこでユーザー登録もAPIで利用できるようにするために
<code>config/application.rb</code>でdeviseがjsonのリクエストにも対応できるように設定します。</p>
<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">DeviseApiUse</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># 中略</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">to_prepare</span> <span class="k">do</span>
      <span class="no">DeviseController</span><span class="p">.</span><span class="nf">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>なお、<a href="http://edgeguides.rubyonrails.org/4_2_release_notes.html">rails 4.2 release notes</a>にクラスレベルの<code>respond_to</code>は削除されたので、<a href="https://github.com/plataformatec/responders">responders</a>を追加してね、とあるので今後少し注意かもしれません。</p>

<blockquote>
<p>respond_with and the corresponding class-level respond_to have been moved to the responders gem.
To use the following, add gem &lsquo;responders&rsquo;, &rsquo;~&gt; 2.0&rsquo; to your Gemfile:</p>
</blockquote>

<p>APIでのログイン時、アクセストークンが無い場合に生成して返すように、ログインの動作を拡張します。</p>

<p>これでユーザー登録もAPIで利用可能になりました。<br>
APIでのログイン時、ユーザー情報のJSONを返すのですが、
ユーザーがトークンを発行していない場合は改めてトークン発行APIを叩く必要があります。　　
そこで、APIでのログイン時のみ、「トークンが発行されていない場合は作成する」ように拡張します。</p>

<p>deviseのコントローラーを拡張するので、
<code>config/routes.rb</code>でdeviseのルーティングをカスタマイズし、独自コントローラーに向くようにします。</p>
<pre class="highlight ruby"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:notes</span>
  <span class="n">resource</span> <span class="ss">:authentication_token</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>

  <span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">controllers: </span><span class="p">{</span> <span class="ss">sessions: </span><span class="s2">"sessions"</span>  <span class="p">}</span>
  <span class="n">root</span> <span class="ss">to: </span><span class="s1">'home#index'</span>
<span class="k">end</span>
</code></pre>

<p><code>Devise::SessionsController</code>を継承した<code>app/controllers/sessions_controller.rb</code>でログイン時の動作を拡張します。</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">SessionsController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">super</span> <span class="k">do</span> <span class="o">|</span><span class="n">resource</span><span class="o">|</span>
      <span class="n">resource</span><span class="p">.</span><span class="nf">ensure_authentication_token</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">format</span><span class="p">.</span><span class="nf">json?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p><code>Devise::SessionsController</code>の<code>create</code>にはブロックを渡せるので、
それによってAPIでのログイン時にトークンが無い場合には発行してからレスポンスを返すようにしています。</p>

</section><section><header><h3>APIのリクエストを試してみる</h3></header>

<p>最後にAPIでのリクエストを試してみます。</p>

<h4>ユーザー登録</h4>

<p>リクエスト</p>
<pre class="highlight shell"><code>curl -v -H <span class="s2">"Accept: application/json"</span> -H <span class="s2">"Content-type: application/json"</span> -X POST -d <span class="s1">'{"user":{"email":"hoge@gmail.com","password":"hogehoge","password_confirmation":"hogehoge"}}'</span> <span class="s2">"http://localhost:3000/users.json"</span>
</code></pre>

<p>レスポンス</p>
<pre class="highlight json"><code><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">"email"</span><span class="p">:</span><span class="s2">"hoge@gmail.com"</span><span class="p">,</span><span class="s2">"authentication_token"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="s2">"created_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:10:56.054Z"</span><span class="p">,</span><span class="s2">"updated_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:10:56.057Z"</span><span class="p">}</span><span class="w">
</span></code></pre>

<h4>ログイン（アクセストークンの取得）</h4>

<p>リクエスト</p>
<pre class="highlight shell"><code>curl -v -H <span class="s2">"Accept: application/json"</span> -H <span class="s2">"Content-type: application/json"</span> -X POST -d <span class="s1">'{"user":{"email":"hoge@gmail.com","password":"hogehoge"}}'</span>  <span class="s2">"http://localhost:3000/users/sign_in.json"</span>
</code></pre>

<p>レスポンス</p>
<pre class="highlight json"><code><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">"email"</span><span class="p">:</span><span class="s2">"hoge@gmail.com"</span><span class="p">,</span><span class="s2">"authentication_token"</span><span class="p">:</span><span class="s2">"jLJyLg_o3crPPhfUoCrA4kzdrHxP31Fc"</span><span class="p">,</span><span class="s2">"created_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:10:56.054Z"</span><span class="p">,</span><span class="s2">"updated_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:11:45.007Z"</span><span class="p">}</span><span class="w">
</span></code></pre>

<h4>リソースへのアクセス</h4>

<p>ノート作成リクエスト</p>
<pre class="highlight shell"><code>curl -v -H <span class="s2">"Accept: application/json"</span> -H <span class="s2">"Content-type: application/json"</span> -X POST -d <span class="s1">'{"note":{"title":"test","body":"hoge"}}'</span> <span class="s2">"http://localhost:3000/notes.json?email=hoge@gmail.com&amp;token=jLJyLg_o3crPPhfUoCrA4kzdrHxP31Fc"</span>
</code></pre>

<p>レスポンス</p>
<pre class="highlight json"><code><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">"user_id"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">"title"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"body"</span><span class="p">:</span><span class="s2">"hoge"</span><span class="p">,</span><span class="s2">"created_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:13:20.355Z"</span><span class="p">,</span><span class="s2">"updated_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:13:20.355Z"</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>ノート一覧リクエスト</p>
<pre class="highlight shell"><code>curl -v -H <span class="s2">"Accept: application/json"</span> -H <span class="s2">"Content-type: application/json"</span> <span class="s2">"http://localhost:3000/notes.json?email=hoge@gmail.com&amp;token=jLJyLg_o3crPPhfUoCrA4kzdrHxP31Fc"</span>
</code></pre>

<p>レスポンス</p>
<pre class="highlight json"><code><span class="p">[{</span><span class="s2">"id"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">"user_id"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">"title"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"body"</span><span class="p">:</span><span class="s2">"hoge"</span><span class="p">,</span><span class="s2">"url"</span><span class="p">:</span><span class="s2">"http://localhost:3000/notes/11.json"</span><span class="p">}]</span><span class="w">
</span></code></pre>

<h4>アクセストークンの更新</h4>

<p>リクエスト</p>
<pre class="highlight shell"><code>curl -v -H <span class="s2">"Accept: application/json"</span> -H <span class="s2">"Content-type: application/json"</span> -X PUT -d <span class="s1">''</span> <span class="s2">"http://localhost:3000/authentication_token.json?email=hoge@gmail.com&amp;token=jLJyLg_o3crPPhfUoCrA4kzdrHxP31Fc"</span>
</code></pre>

<p>レスポンス</p>
<pre class="highlight json"><code><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">"email"</span><span class="p">:</span><span class="s2">"hoge@gmail.com"</span><span class="p">,</span><span class="s2">"authentication_token"</span><span class="p">:</span><span class="s2">"WNRPupEy9f5CWiQE71kFQQEHut5DZxBc"</span><span class="p">,</span><span class="s2">"created_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:10:56.054Z"</span><span class="p">,</span><span class="s2">"updated_at"</span><span class="p">:</span><span class="s2">"2014-09-14T10:16:57.923Z"</span><span class="p">}</span><span class="w">
</span></code></pre>

<h4>アクセストークンの削除</h4>

<p>リクエスト</p>
<pre class="highlight shell"><code>curl -v -H <span class="s2">"Accept: application/json"</span> -H <span class="s2">"Content-type: application/json"</span> -X DELETE <span class="s2">"http://localhost:3000/authentication_token.json?email=hoge@gmail.com&amp;token=WNRPupEy9f5CWiQE71kFQQEHut5DZxBc"</span>
</code></pre>
</section>
</article>
</div>
</div>
</div>
</div>
<div id='footer'>
<div class='container'>
<div class='row'>
<!-- Posts -->
<section class='6u'>
<header>
<h2 class='fa fa-angle-left circled solo'>
<span>Next Article</span>
</h2>
</header>
<ul class='divided'>
<li>
<article class='post stub'>
<header>
<h3>
<a href="/article/2014/12/16/rails-tips/">早く知っておけば良かったrailsの技</a>
</h3>
</header>
<span class='timestamp'>next article</span>
</article>
</li>
</ul>
</section>
<!-- Posts -->
<section class='6u'>
<header>
<h2 class='fa fa-angle-right circled solo'>
<span>Prev Article</span>
</h2>
</header>
<ul class='divided'>
<li>
<article class='post stub'>
<header>
<h3>
<a href="/article/2014/07/23/gitconfig/">gitconfigで設定していること</a>
</h3>
</header>
<span class='timestamp'>prev article</span>
</article>
</li>
</ul>
</section>
</div>
</div>
</div>

</body>
</html>
